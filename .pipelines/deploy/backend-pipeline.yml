# Backend Deployment Pipeline
# Builds and deploys the .NET GraphQL API to Azure Container Apps
# Stages: Build -> Dev -> Prod (manual approval required for prod)

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - src/**
      - .pipelines/deploy/backend-pipeline.yml

pr: none

pool:
  vmImage: 'ubuntu-latest'

variables:
  - template: ../vars/consts.yaml
  # Service connection names for each scope
  - name: sharedServiceConnection
    value: 'mtg-shared'
  - name: devServiceConnection
    value: 'mtg-dev'
  - name: prodServiceConnection
    value: 'mtg-prod'
  - name: dotnetVersion
    value: '9.0.x'
  - name: projectPath
    value: 'src/App.MtgDiscovery.GraphQL/App.MtgDiscovery.GraphQL.csproj'
  - name: buildConfiguration
    value: 'Release'

stages:
  - stage: Build
    displayName: 'Build and Push Container'
    jobs:
      - job: BuildContainer
        displayName: 'Build .NET Container Image'
        steps:
          - template: ../shared/resource-names.yml
            parameters:
              environment: 'shared'
              includeShared: true

          - task: UseDotNet@2
            displayName: 'Install .NET SDK'
            inputs:
              packageType: 'sdk'
              version: $(dotnetVersion)

          - task: AzureCLI@2
            displayName: 'Login to Azure Container Registry'
            inputs:
              azureSubscription: $(sharedServiceConnection)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Get ACR credentials (using mtg-shared service connection)
                ACR_NAME=$(sharedNames.containerRegistryName)
                ACR_USERNAME=$(az acr credential show --name $ACR_NAME --query username -o tsv)
                ACR_PASSWORD=$(az acr credential show --name $ACR_NAME --query passwords[0].value -o tsv)
                ACR_SERVER=$(az acr show --name $ACR_NAME --query loginServer -o tsv)

                # Login to ACR using docker
                echo $ACR_PASSWORD | docker login $ACR_SERVER --username $ACR_USERNAME --password-stdin

                echo "##vso[task.setvariable variable=containerRegistryServer]$ACR_SERVER"
                echo "ACR Login Server: $ACR_SERVER"
                echo "Using service connection: $(sharedServiceConnection)"

          - task: DotNetCoreCLI@2
            displayName: 'Build and Push Container Image'
            inputs:
              command: 'publish'
              publishWebProjects: false
              projects: $(projectPath)
              arguments: >-
                --configuration $(buildConfiguration)
                /t:PublishContainer
                /p:ContainerImageName=$(appName)-backend
                /p:ContainerImageTag=$(Build.BuildId)
                /p:ContainerRegistry=$(containerRegistryServer)
              zipAfterPublish: false
              modifyOutputPath: false

          - pwsh: |
              Write-Host "Container image built and pushed successfully"
              Write-Host "Image: $(containerRegistryServer)/$(appName)-backend:$(Build.BuildId)"
              Write-Host "##vso[task.setvariable variable=containerImage;isOutput=true]$(containerRegistryServer)/$(appName)-backend:$(Build.BuildId)"
            displayName: 'Set Container Image Variable'
            name: containerInfo

  - stage: DeployDev
    displayName: 'Deploy to Dev'
    dependsOn: Build
    condition: succeeded()
    variables:
      - template: ../vars/dev.yaml
      - name: containerImage
        value: $[ stageDependencies.Build.BuildContainer.outputs['containerInfo.containerImage'] ]
    jobs:
      - deployment: DeployToDevContainerApp
        displayName: 'Deploy to Dev Environment'
        environment: 'dev'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: none

                - template: ../shared/resource-names.yml
                  parameters:
                    environment: 'dev'
                    includeShared: true

                - template: ../shared/get-resource-info.yml
                  parameters:
                    resourceGroupName: $(envNames.resourceGroupName)
                    cosmosDbName: $(envNames.cosmosDbName)
                    appInsightsName: $(envNames.appInsightsName)
                    containerRegistryName: $(sharedNames.containerRegistryName)
                    managedIdentityName: $(envNames.managedIdentityName)
                    azureSubscription: $(devServiceConnection)
                    sharedServiceConnection: $(sharedServiceConnection)

                - task: AzureCLI@2
                  displayName: 'Update Container App with New Image (RBAC)'
                  inputs:
                    azureSubscription: $(devServiceConnection)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Deploying image: $(containerImage)"
                      echo "To container app: $(envNames.containerAppName)"
                      echo "Using managed identity for ACR pull and Cosmos DB access"

                      # Update container app (no ACR credentials - uses managed identity)
                      az containerapp update \
                        --name $(envNames.containerAppName) \
                        --resource-group $(envNames.resourceGroupName) \
                        --image $(containerImage) \
                        --set-env-vars \
                          ASPNETCORE_ENVIRONMENT=Development \
                          CosmosConfiguration__Endpoint=$(cosmosDbInfo.endpoint) \
                          CosmosConfiguration__DatabaseName=MtgDiscoveryDb \
                          Auth0__Domain=$(auth0Domain) \
                          Auth0__Audience=$(auth0Audience) \
                          APPLICATIONINSIGHTS_CONNECTION_STRING=$(appInsightsInfo.connectionString) \
                          AZURE_CLIENT_ID=$(managedIdentityInfo.clientId)

                      # Configure health probes
                      echo "Configuring health probes (startup, liveness, readiness)"

                      # Startup probe - gives app 60 seconds to initialize (6s × 10 = 60s)
                      az containerapp update \
                        --name $(envNames.containerAppName) \
                        --resource-group $(envNames.resourceGroupName) \
                        --health-probe-type startup \
                        --health-probe-transport http \
                        --health-probe-path /health \
                        --health-probe-interval 6 \
                        --health-probe-timeout 15 \
                        --health-probe-failure-threshold 10 \
                        --health-probe-success-threshold 1

                      # Liveness probe - check every 30s, restart if 10 consecutive failures
                      az containerapp update \
                        --name $(envNames.containerAppName) \
                        --resource-group $(envNames.resourceGroupName) \
                        --health-probe-type liveness \
                        --health-probe-transport http \
                        --health-probe-path /health \
                        --health-probe-interval 30 \
                        --health-probe-timeout 15 \
                        --health-probe-failure-threshold 10 \
                        --health-probe-success-threshold 1

                      # Readiness probe - check every 30s, remove from LB if 10 consecutive failures
                      az containerapp update \
                        --name $(envNames.containerAppName) \
                        --resource-group $(envNames.resourceGroupName) \
                        --health-probe-type readiness \
                        --health-probe-transport http \
                        --health-probe-path /health \
                        --health-probe-interval 30 \
                        --health-probe-timeout 15 \
                        --health-probe-failure-threshold 10 \
                        --health-probe-success-threshold 1

                      echo "Container App updated successfully with health probes"
                      echo "Using managed identity client ID: $(managedIdentityInfo.clientId)"

                - template: steps/verify-deployment.yml
                  parameters:
                    containerAppName: $(envNames.containerAppName)
                    resourceGroupName: $(envNames.resourceGroupName)
                    azureSubscription: $(devServiceConnection)

  - stage: DeployProd
    displayName: 'Deploy to Production'
    dependsOn:
      - Build
      - DeployDev
    condition: succeeded()
    variables:
      - template: ../vars/prod.yaml
      - name: containerImage
        value: $[ stageDependencies.Build.BuildContainer.outputs['containerInfo.containerImage'] ]
    jobs:
      - deployment: DeployToProdContainerApp
        displayName: 'Deploy to Production Environment'
        environment: 'production' # This will require manual approval
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: none

                - template: ../shared/resource-names.yml
                  parameters:
                    environment: 'prod'
                    includeShared: true

                - template: ../shared/get-resource-info.yml
                  parameters:
                    resourceGroupName: $(envNames.resourceGroupName)
                    cosmosDbName: $(envNames.cosmosDbName)
                    appInsightsName: $(envNames.appInsightsName)
                    containerRegistryName: $(sharedNames.containerRegistryName)
                    managedIdentityName: $(envNames.managedIdentityName)
                    azureSubscription: $(prodServiceConnection)
                    sharedServiceConnection: $(sharedServiceConnection)

                - task: AzureCLI@2
                  displayName: 'Update Container App with New Image (RBAC)'
                  inputs:
                    azureSubscription: $(prodServiceConnection)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Deploying image: $(containerImage)"
                      echo "To container app: $(envNames.containerAppName)"
                      echo "Using managed identity for ACR pull and Cosmos DB access"

                      # Update container app (no ACR credentials - uses managed identity)
                      az containerapp update \
                        --name $(envNames.containerAppName) \
                        --resource-group $(envNames.resourceGroupName) \
                        --image $(containerImage) \
                        --set-env-vars \
                          ASPNETCORE_ENVIRONMENT=Production \
                          CosmosConfiguration__Endpoint=$(cosmosDbInfo.endpoint) \
                          CosmosConfiguration__DatabaseName=MtgDiscoveryDb \
                          Auth0__Domain=$(auth0Domain) \
                          Auth0__Audience=$(auth0Audience) \
                          APPLICATIONINSIGHTS_CONNECTION_STRING=$(appInsightsInfo.connectionString) \
                          AZURE_CLIENT_ID=$(managedIdentityInfo.clientId)

                      # Configure health probes
                      echo "Configuring health probes (startup, liveness, readiness)"

                      # Startup probe - gives app 60 seconds to initialize (6s × 10 = 60s)
                      az containerapp update \
                        --name $(envNames.containerAppName) \
                        --resource-group $(envNames.resourceGroupName) \
                        --health-probe-type startup \
                        --health-probe-transport http \
                        --health-probe-path /health \
                        --health-probe-interval 6 \
                        --health-probe-timeout 15 \
                        --health-probe-failure-threshold 10 \
                        --health-probe-success-threshold 1

                      # Liveness probe - check every 30s, restart if 10 consecutive failures
                      az containerapp update \
                        --name $(envNames.containerAppName) \
                        --resource-group $(envNames.resourceGroupName) \
                        --health-probe-type liveness \
                        --health-probe-transport http \
                        --health-probe-path /health \
                        --health-probe-interval 30 \
                        --health-probe-timeout 15 \
                        --health-probe-failure-threshold 10 \
                        --health-probe-success-threshold 1

                      # Readiness probe - check every 30s, remove from LB if 10 consecutive failures
                      az containerapp update \
                        --name $(envNames.containerAppName) \
                        --resource-group $(envNames.resourceGroupName) \
                        --health-probe-type readiness \
                        --health-probe-transport http \
                        --health-probe-path /health \
                        --health-probe-interval 30 \
                        --health-probe-timeout 15 \
                        --health-probe-failure-threshold 10 \
                        --health-probe-success-threshold 1

                      echo "Container App updated successfully with health probes"
                      echo "Using managed identity client ID: $(managedIdentityInfo.clientId)"

                - template: steps/verify-deployment.yml
                  parameters:
                    containerAppName: $(envNames.containerAppName)
                    resourceGroupName: $(envNames.resourceGroupName)
                    azureSubscription: $(prodServiceConnection)
