# Template to verify Container App deployment

parameters:
  - name: containerAppName
    type: string
  - name: resourceGroupName
    type: string
  - name: azureSubscription
    type: string

steps:
  - task: AzureCLI@2
    displayName: 'Verify Deployment'
    inputs:
      azureSubscription: ${{ parameters.azureSubscription }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "Verifying deployment for ${{ parameters.containerAppName }}"

        # Get Container App FQDN
        FQDN=$(az containerapp show \
          --name ${{ parameters.containerAppName }} \
          --resource-group ${{ parameters.resourceGroupName }} \
          --query properties.configuration.ingress.fqdn \
          -o tsv)

        echo "Container App URL: https://$FQDN"

        # Wait for app to stabilize
        echo "Waiting for application to stabilize..."
        sleep 30

        # Check if app is responding
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://$FQDN/" || echo "000")

        if [ "$HTTP_CODE" != "000" ]; then
          echo "Application is responding with HTTP code: $HTTP_CODE"
          echo "Deployment verified successfully"
        else
          echo "Warning: Application not responding. Check logs for details."
          echo "This may be normal if the app takes longer to start."
        fi

        # Show recent logs
        echo "Recent application logs:"
        az containerapp logs show \
          --name ${{ parameters.containerAppName }} \
          --resource-group ${{ parameters.resourceGroupName }} \
          --tail 20 \
          --follow false \
          || echo "Logs not available yet"
